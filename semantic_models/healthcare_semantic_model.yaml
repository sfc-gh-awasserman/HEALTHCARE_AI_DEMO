name: "AHF_Healthcare_Analytics"
description: "Semantic model for Aids Healthcare Foundation combining AthenaHealth EHR and McKesson Pharmacy data"

# Define the logical tables that will be used in the semantic model
tables:
  - name: "patients"
    description: "Patient demographics and basic information from AthenaHealth EHR"
    base_table: "AHF_HEALTHCARE_DEMO.ATHENA_EHR.PATIENTS"
    primary_key: "PATIENT_ID"
    columns:
      - name: "PATIENT_ID"
        description: "Unique patient identifier"
        data_type: "VARCHAR"
      - name: "FIRST_NAME"
        description: "Patient first name"
        data_type: "VARCHAR"
      - name: "LAST_NAME"
        description: "Patient last name"
        data_type: "VARCHAR"
      - name: "DATE_OF_BIRTH"
        description: "Patient date of birth"
        data_type: "DATE"
      - name: "GENDER"
        description: "Patient gender (M/F)"
        data_type: "VARCHAR"
      - name: "CITY"
        description: "Patient city"
        data_type: "VARCHAR"
      - name: "STATE"
        description: "Patient state"
        data_type: "VARCHAR"
      - name: "PRIMARY_CARE_PROVIDER"
        description: "Primary care provider name"
        data_type: "VARCHAR"

  - name: "encounters"
    description: "Patient encounters and visits from AthenaHealth EHR"
    base_table: "AHF_HEALTHCARE_DEMO.ATHENA_EHR.ENCOUNTERS"
    primary_key: "ENCOUNTER_ID"
    columns:
      - name: "ENCOUNTER_ID"
        description: "Unique encounter identifier"
        data_type: "VARCHAR"
      - name: "PATIENT_ID"
        description: "Patient identifier (foreign key)"
        data_type: "VARCHAR"
      - name: "ENCOUNTER_DATE"
        description: "Date of the encounter"
        data_type: "DATE"
      - name: "ENCOUNTER_TYPE"
        description: "Type of encounter (Office Visit, Telehealth, etc.)"
        data_type: "VARCHAR"
      - name: "PROVIDER_NAME"
        description: "Healthcare provider name"
        data_type: "VARCHAR"
      - name: "CHIEF_COMPLAINT"
        description: "Patient's chief complaint"
        data_type: "VARCHAR"
      - name: "DIAGNOSIS_CODE"
        description: "ICD-10 diagnosis code"
        data_type: "VARCHAR"
      - name: "DIAGNOSIS_DESCRIPTION"
        description: "Diagnosis description"
        data_type: "VARCHAR"
      - name: "CLINICAL_NOTES"
        description: "Clinical notes from the encounter"
        data_type: "TEXT"
      - name: "VISIT_DURATION_MINUTES"
        description: "Duration of visit in minutes"
        data_type: "INTEGER"
      - name: "FOLLOW_UP_NEEDED"
        description: "Whether follow-up is needed"
        data_type: "BOOLEAN"

  - name: "appointments"
    description: "Scheduled appointments from AthenaHealth EHR"
    base_table: "AHF_HEALTHCARE_DEMO.ATHENA_EHR.APPOINTMENTS"
    primary_key: "APPOINTMENT_ID"
    columns:
      - name: "APPOINTMENT_ID"
        description: "Unique appointment identifier"
        data_type: "VARCHAR"
      - name: "PATIENT_ID"
        description: "Patient identifier (foreign key)"
        data_type: "VARCHAR"
      - name: "APPOINTMENT_DATE"
        description: "Date of the appointment"
        data_type: "DATE"
      - name: "APPOINTMENT_TYPE"
        description: "Type of appointment"
        data_type: "VARCHAR"
      - name: "PROVIDER_NAME"
        description: "Healthcare provider name"
        data_type: "VARCHAR"
      - name: "STATUS"
        description: "Appointment status"
        data_type: "VARCHAR"
      - name: "REASON_FOR_VISIT"
        description: "Reason for the visit"
        data_type: "VARCHAR"

  - name: "prescriptions"
    description: "Prescription data from McKesson Pharmacy system"
    base_table: "AHF_HEALTHCARE_DEMO.MCKESSON_PHARMACY.PRESCRIPTIONS"
    primary_key: "PRESCRIPTION_ID"
    columns:
      - name: "PRESCRIPTION_ID"
        description: "Unique prescription identifier"
        data_type: "VARCHAR"
      - name: "PATIENT_ID"
        description: "Patient identifier (foreign key)"
        data_type: "VARCHAR"
      - name: "PRESCRIBER_NAME"
        description: "Prescribing provider name"
        data_type: "VARCHAR"
      - name: "MEDICATION_NAME"
        description: "Name of prescribed medication"
        data_type: "VARCHAR"
      - name: "MEDICATION_STRENGTH"
        description: "Medication strength/dosage"
        data_type: "VARCHAR"
      - name: "QUANTITY"
        description: "Quantity prescribed"
        data_type: "INTEGER"
      - name: "DAYS_SUPPLY"
        description: "Days supply of medication"
        data_type: "INTEGER"
      - name: "PRESCRIBED_DATE"
        description: "Date prescription was written"
        data_type: "DATE"
      - name: "FILLED_DATE"
        description: "Date prescription was filled"
        data_type: "DATE"
      - name: "PICKUP_DATE"
        description: "Date prescription was picked up"
        data_type: "DATE"
      - name: "PICKUP_STATUS"
        description: "Pickup status (Picked Up, Not Picked Up)"
        data_type: "VARCHAR"
      - name: "PHARMACY_LOCATION"
        description: "Pharmacy location name"
        data_type: "VARCHAR"
      - name: "REFILLS_REMAINING"
        description: "Number of refills remaining"
        data_type: "INTEGER"

# Define relationships between tables
relationships:
  - name: "patient_encounters"
    description: "Relationship between patients and their encounters"
    from_table: "encounters"
    from_column: "PATIENT_ID"
    to_table: "patients"
    to_column: "PATIENT_ID"
    relationship_type: "many_to_one"

  - name: "patient_appointments"
    description: "Relationship between patients and their appointments"
    from_table: "appointments"
    from_column: "PATIENT_ID"
    to_table: "patients"
    to_column: "PATIENT_ID"
    relationship_type: "many_to_one"

  - name: "patient_prescriptions"
    description: "Relationship between patients and their prescriptions"
    from_table: "prescriptions"
    from_column: "PATIENT_ID"
    to_table: "patients"
    to_column: "PATIENT_ID"
    relationship_type: "many_to_one"

# Define dimensions for analysis
dimensions:
  - name: "patient_name"
    description: "Patient full name"
    expr: "CONCAT(patients.FIRST_NAME, ' ', patients.LAST_NAME)"
    data_type: "VARCHAR"

  - name: "patient_age"
    description: "Patient age in years"
    expr: "DATEDIFF('year', patients.DATE_OF_BIRTH, CURRENT_DATE())"
    data_type: "INTEGER"

  - name: "encounter_date"
    description: "Date of encounter"
    expr: "encounters.ENCOUNTER_DATE"
    data_type: "DATE"

  - name: "encounter_month"
    description: "Month of encounter"
    expr: "DATE_TRUNC('month', encounters.ENCOUNTER_DATE)"
    data_type: "DATE"

  - name: "encounter_type"
    description: "Type of encounter"
    expr: "encounters.ENCOUNTER_TYPE"
    data_type: "VARCHAR"

  - name: "provider_name"
    description: "Healthcare provider name"
    expr: "encounters.PROVIDER_NAME"
    data_type: "VARCHAR"

  - name: "prescription_status"
    description: "Prescription pickup status"
    expr: "prescriptions.PICKUP_STATUS"
    data_type: "VARCHAR"

  - name: "medication_name"
    description: "Medication name"
    expr: "prescriptions.MEDICATION_NAME"
    data_type: "VARCHAR"

  - name: "pharmacy_location"
    description: "Pharmacy location"
    expr: "prescriptions.PHARMACY_LOCATION"
    data_type: "VARCHAR"

# Define metrics for analysis
metrics:
  - name: "total_encounters"
    description: "Total number of patient encounters"
    expr: "COUNT(encounters.ENCOUNTER_ID)"
    data_type: "INTEGER"

  - name: "unique_patients"
    description: "Number of unique patients"
    expr: "COUNT(DISTINCT patients.PATIENT_ID)"
    data_type: "INTEGER"

  - name: "avg_visit_duration"
    description: "Average visit duration in minutes"
    expr: "AVG(encounters.VISIT_DURATION_MINUTES)"
    data_type: "FLOAT"

  - name: "total_prescriptions"
    description: "Total number of prescriptions"
    expr: "COUNT(prescriptions.PRESCRIPTION_ID)"
    data_type: "INTEGER"

  - name: "unpicked_prescriptions"
    description: "Number of prescriptions not picked up"
    expr: "COUNT(CASE WHEN prescriptions.PICKUP_STATUS = 'Not Picked Up' THEN 1 END)"
    data_type: "INTEGER"

  - name: "prescription_adherence_rate"
    description: "Percentage of prescriptions picked up"
    expr: "ROUND((COUNT(CASE WHEN prescriptions.PICKUP_STATUS = 'Picked Up' THEN 1 END) * 100.0 / COUNT(prescriptions.PRESCRIPTION_ID)), 2)"
    data_type: "FLOAT"

  - name: "encounters_needing_followup"
    description: "Number of encounters requiring follow-up"
    expr: "COUNT(CASE WHEN encounters.FOLLOW_UP_NEEDED = TRUE THEN 1 END)"
    data_type: "INTEGER"

  - name: "upcoming_appointments"
    description: "Number of upcoming scheduled appointments"
    expr: "COUNT(CASE WHEN appointments.APPOINTMENT_DATE >= CURRENT_DATE() AND appointments.STATUS = 'Scheduled' THEN 1 END)"
    data_type: "INTEGER"
